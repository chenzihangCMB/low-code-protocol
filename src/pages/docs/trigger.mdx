---
title: 触发器
description: 在记录增删改前和增删改查之后自动触发一段代码逻辑。
---

触发器是一种特殊的微代码，主要用于校验和处理数据。

- 触发器在执行时需要考虑数据库事务。
- 触发器由[软件包服务](./service-package)加载，在软件包安装和更新时，统一提交给[元数据服务](./service-metadata)集中存储。
- 触发器在[记录服务](./service-records)中统一执行。
- 触发器中不得引用第三方包。

## 触发器定义

触发器文件名称以.trigger.js结尾，格式如下：

```js
module.exports = {
    listenTo: '对象API名称',
    beforeInsert: [async] Function,
    beforeUpdate: [async] Function,
    beforeDelete: [async] Function,
    beforeFind: [async] Function,
    afterInsert: [async] Function,
    afterUpdate: [async] Function,
    afterDelete: [async] Function,
}
```

其中

- listenTo: 对象名称，选填。如果没有定义此属性，则取文件名中第一个 . 之前的文字作为listenTo的值，支持通过通配符指向多个对象
- beforeInsert: 数据新增前执行, 选填
- beforeUpdate: 数据修改前执行, 选填
- beforeDelete: 数据删除前执行, 选填
- beforeFind : 查询数据之前执行, 选填
- afterInsert: 数据新增后执行, 选填
- afterUpdate: 数据修改后执行, 选填
- afterDelete: 数据删除后执行, 选填


## 参数说明

所有脚本函数均为无参函数，所属数据可从this中获取，this结构如下

- id: 记录的唯一标识[string],
- userId: 当前用户唯一标识[string],
- spaceId: 当前工作区[string],
- doc: 需要新增/修改的记录内容[json],
- previousDoc: 修改/删除前的记录[json], //仅afterUpdate, afterDelete时存在此属性
- object_name: 当前对象名称[string],
- datasource_name: 数据源名称[string],
- getObject: function(object_name: string)
- query: 查询数据相关参数[json], //仅beforeFind时存在此属性

## 触发器函数的返回值

如果return的是false，则中断操作，如在before.insert里return false,则不执行insert操作。

## 触发器示例

```js
beforeInsert: async function () {
    var doc = this.doc
    if (doc.code) {
        let count = await this.getObject('picklists').count({ filters: [['space', '=', doc.space], ['code', '=', doc.code]] })
        if (count > 0) {
            throw new Error("唯一编码不能重复");
        }
    }
},
```